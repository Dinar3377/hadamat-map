<script>
    let map;
    let startMarker = null;
    let endMarker = null;
    let startPos = null;
    let endPos = null;

    function initMap() {

        // Telegram WebApp init
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: { lat: 15.3694, lng: 44.1910 },
        });

        map.addListener("click", (e) => {
            if (!startMarker) {
                startMarker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                    label: "A"
                });
                startPos = e.latLng;
                document.getElementById("start").innerText =
                    "ðŸš• Ð¢Ð¾Ñ‡ÐºÐ° A: " + e.latLng.lat().toFixed(5) + ", " + e.latLng.lng().toFixed(5);
            } 
            else if (!endMarker) {
                endMarker = new google.maps.Marker({
                    position: e.latLng,
                    map: map,
                    label: "B"
                });
                endPos = e.latLng;
                document.getElementById("end").innerText =
                    "ðŸ“ Ð¢Ð¾Ñ‡ÐºÐ° B: " + e.latLng.lat().toFixed(5) + ", " + e.latLng.lng().toFixed(5);

                document.getElementById("send").disabled = false;
            }
        });

        document.getElementById("send").onclick = () => {
            if (!startPos || !endPos) return;

            const data = {
                start: { lat: startPos.lat(), lng: startPos.lng() },
                end:   { lat: endPos.lat(), lng: endPos.lng() }
            };

            Telegram.WebApp.sendData(JSON.stringify(data));
            Telegram.WebApp.close();
        };
    }
</script>


